# Data Model: Integrated RAG Chatbot for AI-Powered Textbook

## Entities

### TextbookChunk
Represents a semantic chunk of textbook content that has been embedded for retrieval.

- **id**: string (unique identifier for the chunk)
- **content**: string (the actual text content of the chunk)
- **metadata**: object
  - **chapter**: string (chapter title/number where the chunk appears)
  - **section**: string (section title within the chapter)
  - **page**: number (page number where the chunk appears)
  - **book_title**: string (title of the textbook)
  - **section_hierarchy**: array (optional, hierarchical path to the content)
- **embedding_vector**: array (vector representation of the content for similarity search)
- **created_at**: datetime (timestamp when the chunk was created)
- **updated_at**: datetime (timestamp when the chunk was last updated)

**Validation rules:**
- content must not be empty
- embedding_vector must be a valid vector of the expected dimension
- metadata must include at least chapter, section, and page

### Query
Represents a user query or question to the RAG system.

- **id**: string (unique identifier for the query)
- **question**: string (the user's question or query text)
- **selected_text_context**: string (optional, user-selected text to be used instead of vector search)
- **retrieved_chunks**: array (list of TextbookChunk IDs that were retrieved for this query)
- **response**: string (the final answer generated by the system)
- **confidence_score**: float (confidence score of the response based on retrieval relevance)
- **created_at**: datetime (timestamp when the query was created)

**Validation rules:**
- question must not be empty
- selected_text_context, if provided, should be used exclusively
- response must be derived only from retrieved_chunks or selected_text_context

### ChatSession
Represents a user's session with the chatbot.

- **id**: string (unique identifier for the session)
- **user_id**: string (identifier for the user, if available)
- **created_at**: datetime (timestamp when the session was created)
- **updated_at**: datetime (timestamp when the session was last updated)
- **queries**: array (list of Query IDs associated with this session)

**Validation rules:**
- id must be unique
- created_at must be set on creation

## Relationships

- ChatSession 1 → * Query (one session can have multiple queries)
- Query 1 → * TextbookChunk (one query can retrieve multiple chunks)

## State Transitions

### Query State Transitions
1. **CREATED**: Query received from user
2. **RETRIEVING**: Retrieval service is finding relevant chunks
3. **GENERATING**: LLM is generating response from retrieved context
4. **COMPLETED**: Response has been generated and returned to user
5. **REFUSED**: Query was refused because no relevant context was found

**Transitions:**
- CREATED → RETRIEVING (when retrieval begins)
- RETRIEVING → GENERATING (when relevant chunks are found)
- RETRIEVING → REFUSED (when no relevant chunks found)
- GENERATING → COMPLETED (when response is generated)
- GENERATING → REFUSED (when LLM determines answer not in context)